//-----------------------------------------------------------------------------------------------------------------------------;

// DATEBASE;

//-----------------------------------------------------------------------------------------------------------------------------;

var db0 = db.getSiblingDB("daily_master_0");
var db1 = db.getSiblingDB( "goods_list" );

//-----------------------------------------------------------------------------------------------------------------------------;

// COLLECTION;

//-----------------------------------------------------------------------------------------------------------------------------;

var col0 = db0.getCollection( "daily_master" );

//-----------------------------------------------------------------------------------------------------------------------------;

// CREATE INDEX;

//-----------------------------------------------------------------------------------------------------------------------------;

col0.createIndex({ cd$product_master : 1 , date : 1 });

//-----------------------------------------------------------------------------------------------------------------------------;

// VARIABLE;

//-----------------------------------------------------------------------------------------------------------------------------;

var _to;

//-----------------------------------------------------------------------------------------------------------------------------;

// QUERY;

//-----------------------------------------------------------------------------------------------------------------------------;

var _q0 = {
	date : null
}

//-----------------------------------------------------------------------------------------------------------------------------;

// FUNCTION;

//-----------------------------------------------------------------------------------------------------------------------------;

/*
 * 대상일자를 배열로 반환하는 함수;
 * @param {Number} startDate
 * @param {Number} endDate
 * @return {Array} result
 */
var getTargetDays = function( startDate, endDate ){

	var db$2018 = db.getSiblingDB( "Taobao_2018" )
	var db$2019 = db.getSiblingDB( "Taobao_2019" )


	var cols2018 = db$2018.getCollectionNames();
	var cols2019 = db$2019.getCollectionNames();

	var allCols = cols2018.concat( cols2019 ).sort();

	var result = [];

	var i = 0,iLen = allCols.length,io;
	for(;i<iLen;++i){
		io = allCols[ i ];
		if( io * 1 >= startDate &&  io * 1 <= endDate ) result.push( io )
	}

	return result;
};

var FN = function( date ){

	print("-------------------------------------------------------")
	print( date + " / " + Date() )
	print("-------------------------------------------------------")

	var colNm = date.toString();
	var col1 = db1.getCollection( colNm );

	var r = {};

	col1.drop();

	_q0.date = ISODate( date )
	col0.find( _q0 ).forEach(function(doc){
		_to = {}
		_to.keyword = doc.keyword;
		_to.goods_id = doc.goods_id;
		_to._id$brand_basic = doc._id$brand_basic;
		_to.standard_name = doc.standard_name;
		_to.cd$product_master = doc.cd$product_master;
		_to.url = null;

		if( !r[ doc.goods_id] ) r[ doc.goods_id ] = _to;
	})

	var s,so
	for( s in r ){
		//print( s )
		col1.insertOne( r[ s ] );
	}
}

//-----------------------------------------------------------------------------------------------------------------------------;

// LOGIC;

//-----------------------------------------------------------------------------------------------------------------------------;

var targetDays = getTargetDays( 20180401, 20180404);

var i = 0,iLen = targetDays.length,io;
for(;i<iLen;++i){
	io = targetDays[ i ];
	FN( io );
}

return;